generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model users {
  id                     Int              @id @default(autoincrement())
  first_name             String
  last_name              String
  email                  String           @unique
  password               String
  roles                  String[]
  group_access           group_access[]
  createdQuestions       question[]       @relation("CreatedQuestions")
  updatedQuestions       question[]       @relation("UpdatedQuestions")
  surveys                survey[]         @relation("CreatedSurveys")
  updatedSurveys         survey[]         @relation("UpdatedSurveys")
  surveyInstances        surveyInstance[] @relation("CreatedSurveyInstances")
  updatedSurveyInstances surveyInstance[] @relation("UpdatedSurveyInstances")
  booklets               booklet[]        @relation("CreatedBooklets")
}

model group_access {
  id       Int   @id @default(autoincrement())
  group_id Int
  user_id  Int
  users    users @relation(fields: [user_id], references: [id])
}

model question {
  id             Int             @id @default(autoincrement())
  metadata       Json
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  group_id       Int
  status         question_status
  contentJson    Json?
  contentHtml    String?
  correctAnswers Json?

  createdById Int
  updatedById Int

  createdBy       users             @relation("CreatedQuestions", fields: [createdById], references: [id])
  updatedBy       users             @relation("UpdatedQuestions", fields: [updatedById], references: [id])
  bookletQuestion BookletQuestion[]
}

model BookletQuestion {
  bookletId  Int
  questionId Int
  position   Int

  booklet  booklet  @relation(fields: [bookletId], references: [id])
  question question @relation(fields: [questionId], references: [id])

  @@id([bookletId, questionId])
  @@unique([bookletId, position])
}

enum question_status {
  ACTIVE
  LECTURE
  FINISHED
  DELETED
}

enum survey_status {
  ACTIVE
  PREPARED
  IN_PROGRESS
  FINISHED
}

model survey {
  id                     Int              @id @default(autoincrement())
  title                  String
  description            String?
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt
  createdById            Int
  updatedById            Int
  status                 survey_status    @default(IN_PROGRESS)
  mode                   survey_mode
  instances              surveyInstance[]
  booklet                booklet[]
  bookletMappingExcelUrl String?
  bookletVersion         Int              @default(0)

  createdBy users    @relation("CreatedSurveys", fields: [createdById], references: [id])
  updatedBy users    @relation("UpdatedSurveys", fields: [updatedById], references: [id])
  answer    answer[] @relation("BelogsToSurvey")
}

model surveyInstance {
  id             Int      @id @default(autoincrement())
  surveyId       Int
  name           String
  validFrom      DateTime
  validTo        DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdById    Int
  updatedById    Int
  bookletVersion Int      @default(0)

  survey    survey   @relation(fields: [surveyId], references: [id])
  createdBy users    @relation("CreatedSurveyInstances", fields: [createdById], references: [id])
  updatedBy users    @relation("UpdatedSurveyInstances", fields: [updatedById], references: [id])
  answer    answer[] @relation("BelongsToInstance")
}

enum survey_mode {
  DESIGN
  ADAPTIV
}

model booklet {
  id            Int      @id @default(autoincrement())
  bookletId     Int
  surveyId      Int
  excelFileUrl  String
  assignedCount Int      @default(0)
  createdAt     DateTime @default(now())
  createdById   Int
  version       Int      @default(0)

  survey          survey            @relation(fields: [surveyId], references: [id])
  createdBy       users             @relation("CreatedBooklets", fields: [createdById], references: [id])
  answer          answer[]          @relation("BelongsToBooklet")
  BookletQuestion BookletQuestion[]

  @@index([surveyId])
}

model answer {
  id               Int              @id @default(autoincrement())
  surveyId         Int
  instanceId       Int
  bookletId        Int
  userId           String
  questionIds      Int[]
  questionsAnswers questionAnswer[] @relation("BelongsToAnswer")
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  freeParam        String?

  survey   survey         @relation("BelogsToSurvey", fields: [surveyId], references: [id])
  instance surveyInstance @relation("BelongsToInstance", fields: [instanceId], references: [id])
  booklet  booklet        @relation("BelongsToBooklet", fields: [bookletId], references: [id])

  @@unique([surveyId, instanceId, bookletId, userId])
  @@index([userId, instanceId])
}

model questionAnswer {
  id               Int       @id @default(autoincrement())
  answerId         Int
  questionId       Int
  answerJson       Json?
  createdAt        DateTime  @default(now())
  solvedTime       Float?    @default(0.0)
  solvingTimeStart DateTime  @default(now())
  solvingTimeEnd   DateTime?
  skipped          Boolean   @default(false)
  answer           answer    @relation("BelongsToAnswer", fields: [answerId], references: [id])

  @@unique([answerId, questionId])
}
